<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Leaves</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f7fa;
      color: #333;
    }

    h2, h3 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    form {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }

    label {
      font-weight: 600;
      margin: 10px 0 5px;
      display: block;
    }

    input, textarea, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      box-sizing: border-box;
    }

    input:focus, textarea:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 4px rgba(52, 152, 219, 0.4);
    }

    button {
      background: #3498db;
      color: #fff;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #2980b9;
    }

    #feedback {
      font-weight: 600;
      margin-bottom: 10px;
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px 15px;
      text-align: center;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    th {
      background: #3498db;
      color: #fff;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background: #f9f9f9;
    }

    tr:hover {
      background: #f1f7fd;
    }

    p {
      text-align: center;
      margin-top: 20px;
    }

    a {
      color: #3498db;
      text-decoration: none;
      font-weight: 500;
      margin: 0 5px;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h2>Apply for Leave</h2>

  <div id="feedback" style="color:green"></div>

  <form id="leaveForm">
    <label>Date</label>
    <input type="date" id="date" required />
    <label>Reason</label>
    <textarea id="reason" rows="3" required></textarea>
    <button type="submit">Submit Leave</button>
  </form>

  <h3>Your Leaves</h3>
  <table id="leavesTable">
    <thead><tr><th>Date</th><th>Reason</th><th>Granted</th><th>Applied At</th></tr></thead>
    <tbody></tbody>
  </table>

  <p><a href="/profile.html">Profile</a> | <a href="#" id="logout">Logout</a></p>

  <script>
    const token = localStorage.getItem('token');
    if (!token) window.location.href = '/';

    function loadLeaves(){
      $.ajax({
        url: '/api/leaves',
        method: 'GET',
        headers: { Authorization: 'Bearer ' + token },
        success(res){
          const tbody = $('#leavesTable tbody').empty();
          if (!res.length) tbody.append('<tr><td colspan="4">No leaves</td></tr>');
          res.forEach(l => {
            tbody.append(`<tr>
              <td>${new Date(l.date).toLocaleDateString()}</td>
              <td>${l.reason}</td>
              <td>${l.granted ? 'Yes' : 'No'}</td>
              <td>${new Date(l.createdAt).toLocaleString()}</td>
            </tr>`);
          });
        },
        error(){
          localStorage.removeItem('token'); 
          localStorage.removeItem('profile'); 
          window.location.href = '/';
        }
      });
    }

    $('#leaveForm').on('submit', function(e){
      e.preventDefault();
      $('#feedback').text('');
      const date = $('#date').val();
      const reason = $('#reason').val().trim();
      if (!date || !reason) { $('#feedback').css('color','red').text('Fill both fields'); return; }

      $.ajax({
        url: '/api/leaves',
        method: 'POST',
        contentType: 'application/json',
        headers: { Authorization: 'Bearer ' + token },
        data: JSON.stringify({ date, reason }),
        success(res){
          $('#feedback').css('color','green').text('Leave applied');
          $('#reason').val(''); $('#date').val('');
          loadLeaves();
        },
        error(xhr){
          $('#feedback').css('color','red').text(xhr.responseJSON?.message || 'Error');
        }
      });
    });

    $('#logout').on('click', function(e){ 
      e.preventDefault(); 
      localStorage.removeItem('token'); 
      localStorage.removeItem('profile'); 
      window.location.href = '/'; 
    });

    loadLeaves();
  </script>
</body>
</html>
